<?php
/**
 * Shortcode: {{ module_name }}
 * Généré automatiquement le {{ generated_at }}
 *
 * Usage: [{{ snake_name }}_list] ou [{{ snake_name }}_list limit="5" orderby="date" order="DESC"]
 *
 * @package {{ module_name }}
 */

if (!defined('ABSPATH')) {
    exit;
}

/**
 * Shortcode pour afficher la liste des {{ module_name }}s
 *
 * @param array $atts Attributs du shortcode
 * @return string HTML output
 */
function {{ snake_name }}_shortcode($atts) {
    $atts = shortcode_atts(
        array(
            'limit'   => 10,
            'orderby' => 'date',
            'order'   => 'DESC',
            'columns' => 3,
            'class'   => '',
        ),
        $atts,
        '{{ snake_name }}_list'
    );

    $args = array(
        'post_type'      => '{{ slug }}',
        'posts_per_page' => intval($atts['limit']),
        'orderby'        => sanitize_key($atts['orderby']),
        'order'          => in_array(strtoupper($atts['order']), array('ASC', 'DESC')) ? strtoupper($atts['order']) : 'DESC',
        'post_status'    => 'publish',
    );

    $query = new WP_Query($args);

    if (!$query->have_posts()) {
        return '<p class="{{ slug }}-empty">' . esc_html__('Aucun {{ module_name }} trouvé.', '{{ slug }}') . '</p>';
    }

    $columns = intval($atts['columns']);
    $custom_class = sanitize_html_class($atts['class']);

    ob_start();
    ?>
    <div class="{{ slug }}-shortcode-wrapper <?php echo esc_attr($custom_class); ?>">
        <div class="{{ slug }}-grid {{ slug }}-grid--cols-<?php echo esc_attr($columns); ?>">
            <?php while ($query->have_posts()) : $query->the_post(); ?>
                <div class="{{ slug }}-item">

                    <?php if (has_post_thumbnail()) : ?>
                        <div class="{{ slug }}-item__thumbnail">
                            <a href="<?php the_permalink(); ?>">
                                <?php the_post_thumbnail('medium'); ?>
                            </a>
                        </div>
                    <?php endif; ?>

                    <div class="{{ slug }}-item__content">
                        <h3 class="{{ slug }}-item__title">
                            <a href="<?php the_permalink(); ?>">
                                <?php the_title(); ?>
                            </a>
                        </h3>

                        <div class="{{ slug }}-item__excerpt">
                            <?php the_excerpt(); ?>
                        </div>

                        <div class="{{ slug }}-item__fields">
                            {% for field in fields %}
                            <?php
                            ${{ field.name }} = get_field('{{ field.name }}');
                            if (${{ field.name }}) :
                            ?>
                                <div class="{{ slug }}-item__field {{ slug }}-item__field--{{ field.name }}">
                                    {% if field.field_type == 'image' %}
                                    <?php if (is_array(${{ field.name }})) : ?>
                                        <img src="<?php echo esc_url(${{ field.name }}['sizes']['thumbnail']); ?>"
                                             alt="<?php echo esc_attr(${{ field.name }}['alt']); ?>">
                                    <?php endif; ?>
                                    {% elif field.field_type == 'number' %}
                                    <span class="field-label">{{ field.label }}:</span>
                                    <span class="field-value"><?php echo esc_html(number_format_i18n(${{ field.name }})); ?></span>
                                    {% elif field.field_type == 'wysiwyg' %}
                                    <div class="field-value"><?php echo wp_kses_post(wp_trim_words(${{ field.name }}, 20)); ?></div>
                                    {% elif field.field_type == 'date' %}
                                    <span class="field-label">{{ field.label }}:</span>
                                    <span class="field-value"><?php echo esc_html(date_i18n(get_option('date_format'), strtotime(${{ field.name }}))); ?></span>
                                    {% else %}
                                    <span class="field-label">{{ field.label }}:</span>
                                    <span class="field-value"><?php echo esc_html(${{ field.name }}); ?></span>
                                    {% endif %}
                                </div>
                            <?php endif; ?>
                            {% endfor %}
                        </div>

                        <a href="<?php the_permalink(); ?>" class="{{ slug }}-item__link">
                            <?php esc_html_e('Voir plus', '{{ slug }}'); ?>
                        </a>
                    </div>

                </div>
            <?php endwhile; ?>
        </div>
    </div>
    <?php
    wp_reset_postdata();

    return ob_get_clean();
}
add_shortcode('{{ snake_name }}_list', '{{ snake_name }}_shortcode');

/**
 * Shortcode pour afficher un {{ module_name }} unique par ID
 *
 * Usage: [{{ snake_name }}_single id="123"]
 */
function {{ snake_name }}_single_shortcode($atts) {
    $atts = shortcode_atts(
        array(
            'id' => 0,
        ),
        $atts,
        '{{ snake_name }}_single'
    );

    $post_id = intval($atts['id']);

    if (!$post_id) {
        return '';
    }

    $post = get_post($post_id);

    if (!$post || $post->post_type !== '{{ slug }}' || $post->post_status !== 'publish') {
        return '';
    }

    ob_start();
    ?>
    <div class="{{ slug }}-single-shortcode">
        <article class="{{ slug }}-single-item">

            <?php if (has_post_thumbnail($post_id)) : ?>
                <div class="{{ slug }}-single__thumbnail">
                    <?php echo get_the_post_thumbnail($post_id, 'large'); ?>
                </div>
            <?php endif; ?>

            <div class="{{ slug }}-single__content">
                <h2 class="{{ slug }}-single__title">
                    <a href="<?php echo esc_url(get_permalink($post_id)); ?>">
                        <?php echo esc_html(get_the_title($post_id)); ?>
                    </a>
                </h2>

                <div class="{{ slug }}-single__text">
                    <?php echo wp_kses_post(apply_filters('the_content', $post->post_content)); ?>
                </div>

                <div class="{{ slug }}-single__fields">
                    {% for field in fields %}
                    <?php
                    ${{ field.name }} = get_field('{{ field.name }}', $post_id);
                    if (${{ field.name }}) :
                    ?>
                        <div class="{{ slug }}-single__field">
                            <strong>{{ field.label }}:</strong>
                            {% if field.field_type == 'image' %}
                            <?php if (is_array(${{ field.name }})) : ?>
                                <img src="<?php echo esc_url(${{ field.name }}['url']); ?>"
                                     alt="<?php echo esc_attr(${{ field.name }}['alt']); ?>">
                            <?php endif; ?>
                            {% elif field.field_type == 'wysiwyg' %}
                            <div><?php echo wp_kses_post(${{ field.name }}); ?></div>
                            {% elif field.field_type == 'number' %}
                            <span><?php echo esc_html(number_format_i18n(${{ field.name }})); ?></span>
                            {% elif field.field_type == 'date' %}
                            <span><?php echo esc_html(date_i18n(get_option('date_format'), strtotime(${{ field.name }}))); ?></span>
                            {% else %}
                            <span><?php echo esc_html(${{ field.name }}); ?></span>
                            {% endif %}
                        </div>
                    <?php endif; ?>
                    {% endfor %}
                </div>
            </div>

        </article>
    </div>
    <?php

    return ob_get_clean();
}
add_shortcode('{{ snake_name }}_single', '{{ snake_name }}_single_shortcode');
